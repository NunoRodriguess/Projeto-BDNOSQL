-- Quais os livros mais vendidos em Portugal

SELECT 
    BOOK.BOOK_ID,
    BOOK.TITLE,
    COUNTRY.COUNTRY_NAME,
    COUNT(CUST_ORDER.ORDER_ID) AS VENDAS
FROM 
    BOOK
    INNER JOIN ORDER_LINE ON BOOK.BOOK_ID = ORDER_LINE.BOOK_ID
    INNER JOIN CUST_ORDER ON ORDER_LINE.ORDER_ID = CUST_ORDER.ORDER_ID
    INNER JOIN ADDRESS ON CUST_ORDER.DEST_ADDRESS_ID = ADDRESS.ADDRESS_ID
    INNER JOIN COUNTRY ON ADDRESS.COUNTRY_ID = COUNTRY.COUNTRY_ID
WHERE 
    COUNTRY.COUNTRY_NAME = 'Portugal'
GROUP BY 
    BOOK.BOOK_ID, BOOK.TITLE, COUNTRY.COUNTRY_NAME
ORDER BY 
    VENDAS DESC;

-- Autores que mais faturaram

SELECT 
    AUTHOR.AUTHOR_ID,
    AUTHOR.AUTHOR_NAME,
    ROUND(SUM(BOOKSALES.TOTAL/BOOKSALES.NUM_AUTHORS),2) AS EARNINGS 
FROM (
    SELECT 
        BOOK.BOOK_ID,
        SUM(PRICE) as TOTAL,
        COUNT(BOOK_AUTHOR.AUTHOR_ID) AS NUM_AUTHORS
    FROM BOOK
    INNER JOIN ORDER_LINE ON BOOK.BOOK_ID = ORDER_LINE.BOOK_ID
    INNER JOIN BOOK_AUTHOR ON BOOK.BOOK_ID = BOOK_AUTHOR.BOOK_ID
    GROUP BY BOOK.BOOK_ID
) BOOKSALES
INNER JOIN BOOK_AUTHOR ON BOOKSALES.BOOK_ID = BOOK_AUTHOR.BOOK_ID
INNER JOIN AUTHOR ON BOOK_AUTHOR.AUTHOR_ID = AUTHOR.AUTHOR_ID
GROUP BY AUTHOR.AUTHOR_ID, AUTHOR.AUTHOR_NAME
ORDER BY EARNINGS DESC;



SELECT * FROM ORDER_LINE
WHERE ORDER_LINE.BOOK_ID = 1001;