-- Autores que mais faturaram

SELECT 
    AUTHOR.AUTHOR_ID,
    AUTHOR.AUTHOR_NAME,
    ROUND(SUM(BOOKSALES.TOTAL/BOOKSALES.NUM_AUTHORS), 2) AS EARNINGS 
FROM (
    SELECT 
        BOOK.BOOK_ID,
        SUM(ORDER_LINE.PRICE) as TOTAL,
        (SELECT COUNT(*) FROM BOOK_AUTHOR WHERE BOOK_AUTHOR.BOOK_ID = BOOK.BOOK_ID) AS NUM_AUTHORS
    FROM BOOK
    INNER JOIN ORDER_LINE ON BOOK.BOOK_ID = ORDER_LINE.BOOK_ID
    GROUP BY BOOK.BOOK_ID
) BOOKSALES
INNER JOIN BOOK_AUTHOR ON BOOKSALES.BOOK_ID = BOOK_AUTHOR.BOOK_ID
INNER JOIN AUTHOR ON BOOK_AUTHOR.AUTHOR_ID = AUTHOR.AUTHOR_ID
GROUP BY AUTHOR.AUTHOR_ID, AUTHOR.AUTHOR_NAME
ORDER BY EARNINGS DESC;

